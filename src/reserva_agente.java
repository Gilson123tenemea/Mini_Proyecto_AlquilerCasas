
import clases.Agente_inmobiliario;
import clases.Cuerpo_reserva;
import clases.Enc_Reservacion;
import com.db4o.Db4o;
import com.db4o.ObjectContainer;
import com.db4o.ObjectSet;
import com.db4o.query.Query;
import java.util.HashSet;
import java.util.Set;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;

/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
/**
 *
 * @author Lenovo.User
 */
public class reserva_agente extends javax.swing.JPanel {

    /**
     * Creates new form reserva_agente
     */
    public reserva_agente() {
        initComponents();
        txtcasa.setVisible(false);
        txtcliente.setVisible(false);

    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTable1 = new javax.swing.JTable();
        jLabel1 = new javax.swing.JLabel();
        cbxbusqueda = new javax.swing.JComboBox<>();
        jLabel2 = new javax.swing.JLabel();
        txtcliente = new javax.swing.JTextField();
        jButton1 = new javax.swing.JButton();
        txtcasa = new javax.swing.JTextField();

        jPanel1.setBackground(new java.awt.Color(255, 255, 255));
        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jTable1.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        jScrollPane1.setViewportView(jTable1);

        jPanel1.add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 150, 870, 420));

        jLabel1.setFont(new java.awt.Font("Arial", 1, 36)); // NOI18N
        jLabel1.setText("Informe de reservas");
        jPanel1.add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 20, 380, -1));

        cbxbusqueda.setFont(new java.awt.Font("Tahoma", 1, 14)); // NOI18N
        cbxbusqueda.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Seleccione", "Cliente", "Casa vacacional" }));
        cbxbusqueda.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                cbxbusquedaItemStateChanged(evt);
            }
        });
        cbxbusqueda.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                cbxbusquedaMouseClicked(evt);
            }
        });
        cbxbusqueda.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbxbusquedaActionPerformed(evt);
            }
        });
        cbxbusqueda.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                cbxbusquedaPropertyChange(evt);
            }
        });
        cbxbusqueda.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                cbxbusquedaKeyPressed(evt);
            }
        });
        jPanel1.add(cbxbusqueda, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 100, 180, -1));

        jLabel2.setFont(new java.awt.Font("Arial", 1, 18)); // NOI18N
        jLabel2.setText("Buscar por:");
        jPanel1.add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(40, 100, 120, -1));
        jPanel1.add(txtcliente, new org.netbeans.lib.awtextra.AbsoluteConstraints(390, 100, 130, -1));

        jButton1.setText("Buscar");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        jPanel1.add(jButton1, new org.netbeans.lib.awtextra.AbsoluteConstraints(560, 100, 140, -1));
        jPanel1.add(txtcasa, new org.netbeans.lib.awtextra.AbsoluteConstraints(390, 100, 130, -1));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
    }// </editor-fold>//GEN-END:initComponents

    private void cbxbusquedaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbxbusquedaActionPerformed

    }//GEN-LAST:event_cbxbusquedaActionPerformed

    private void cbxbusquedaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_cbxbusquedaMouseClicked

    }//GEN-LAST:event_cbxbusquedaMouseClicked

    private void cbxbusquedaKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_cbxbusquedaKeyPressed

    }//GEN-LAST:event_cbxbusquedaKeyPressed

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed

        if (txtcliente.isVisible()) {

            /*
            ObjectSet<Enc_Reservacion> encReservas = base.queryByExample(new Enc_Reservacion(null, txtcliente.getText().trim(), null));

            for (Enc_Reservacion encReserva : encReservas) {
                String idReserva = encReserva.getId_enc_reserva();
                ObjectSet<Cuerpo_reserva> cuerpoReservas = base.queryByExample(new Cuerpo_reserva(idReserva, null, null, null, null));

                for (Cuerpo_reserva cuerpoReserva : cuerpoReservas) {
                    System.out.println("ID de reserva: " + encReserva.getId_enc_reserva());
                    System.out.println("Fecha de reserva: " + encReserva.getFecha_reserva());
                    System.out.println("Casa: " + cuerpoReserva.getCod_casa());
                    System.out.println("Disponibilidad: " + cuerpoReserva.getDisponibilidad());
                    System.out.println("Fecha de inicio: " + cuerpoReserva.getReserva_cliente());
                    System.out.println("Fecha de fin: " + cuerpoReserva.getFin_reserva());
                    System.out.println();
                }
            }
             */
        } else if (txtcasa.isVisible()) {
            ObjectContainer base = Db4o.openFile(INICIO.direccion);

            Query query = base.query();
            query.constrain(Cuerpo_reserva.class);
            query.descend("cod_casa").constrain(txtcasa.getText().trim());

             ObjectSet<Cuerpo_reserva> result = query.execute();

// Recupera todos los ID de reserva en el resultado
            Set<Cuerpo_reserva> idReservaSet = new HashSet<>();
            for (Cuerpo_reserva cuerpo1 : result) {
                cuerpo1.getId_enc_reserva();
                idReservaSet.add(cuerpo1);
                
            }

// Realiza una consulta para obtener todas las reservas con los ID de reserva recuperados
            Query consulta = base.query();
            consulta.constrain(Enc_Reservacion.class);
            consulta.descend("id_enc_reserva").constrain(idReservaSet);

            ObjectSet<Enc_Reservacion> resul = consulta.execute();

            String[] columnNames = {"CODIGO de reserva", "Cliente", "reservacion", "Fecha final de reserva", " ", " "};

            Object[][] data = new Object[result.size()][6];

            int i = 0;
            for (Cuerpo_reserva cuerpo : result) {
                data[i][0] = cuerpo.getId_enc_reserva();
                data[i][1] = cuerpo.getCod_casa();
                data[i][2] = cuerpo.getReserva_cliente();
                data[i][3] = cuerpo.getFin_reserva();

                if (!resul.isEmpty()) {
                    for (Enc_Reservacion r : resul) {
                        // rest of the code
                        System.out.println("hsdvfdghkhjfhj");
                        if (r.getId_enc_reserva().equals(cuerpo.getId_enc_reserva())) {
                            data[i][4] = r.getCod_cliente();
                            data[i][5] = r.getFecha_reserva();

                        }
                    }
                } else {
                    System.out.println("No se encontraron registros que coincidan.");
                }

                /*
                // Encuentra la reserva asociada con este cuerpo_reserva y extrae la informaci√≥n necesaria
                for (Enc_Reservacion r : encReservas) {

                    System.out.println("hsdvfdghkhjfhj");
                    if (r.getId_enc_reserva().equals(cuerpo.getId_enc_reserva())) {
                        data[i][4] = r.getCod_cliente();
                        data[i][5] = r.getFecha_reserva();

                    }
                }
                 */
                i++;
            }

            DefaultTableModel model = new DefaultTableModel(data, columnNames);
            jTable1.setModel(model);

            base.close();
        } else {
            JOptionPane.showMessageDialog(null, "Escoja como quiere buscar la reserva mediante un cliente o mediante una casa");
        }
    }//GEN-LAST:event_jButton1ActionPerformed

    private void cbxbusquedaPropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_cbxbusquedaPropertyChange
        // TODO add your handling code here:

    }//GEN-LAST:event_cbxbusquedaPropertyChange

    public static void mostrarConsulta(ObjectContainer db) {
        ObjectSet<Enc_Reservacion> encReservas = db.queryByExample(new Enc_Reservacion(null, INICIO.codigo, null));

        for (Enc_Reservacion encReserva : encReservas) {
            String idReserva = encReserva.getId_enc_reserva();
            ObjectSet<Cuerpo_reserva> cuerpoReservas = db.queryByExample(new Cuerpo_reserva(idReserva, null, null, null, null));

            for (Cuerpo_reserva cuerpoReserva : cuerpoReservas) {
                System.out.println("ID de reserva: " + encReserva.getId_enc_reserva());
                System.out.println("Fecha de reserva: " + encReserva.getFecha_reserva());
                System.out.println("Casa: " + cuerpoReserva.getCod_casa());
                System.out.println("Disponibilidad: " + cuerpoReserva.getDisponibilidad());
                System.out.println("Fecha de inicio: " + cuerpoReserva.getReserva_cliente());
                System.out.println("Fecha de fin: " + cuerpoReserva.getFin_reserva());
                System.out.println();
            }
        }
    }

    private void cbxbusquedaItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_cbxbusquedaItemStateChanged
        if (cbxbusqueda.getSelectedItem().toString().equalsIgnoreCase("seleccione")) {
            txtcasa.setVisible(false);
            txtcliente.setVisible(false);
        } else if (cbxbusqueda.getSelectedItem().toString().equalsIgnoreCase("cliente")) {
            txtcliente.setVisible(true);
            txtcliente.setText("cedula");
        } else if (cbxbusqueda.getSelectedItem().toString().equalsIgnoreCase("Casa vacacional")) {
            txtcasa.setVisible(true);
            txtcasa.setText("codigo");
        }
    }//GEN-LAST:event_cbxbusquedaItemStateChanged


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JComboBox<String> cbxbusqueda;
    private javax.swing.JButton jButton1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable jTable1;
    private javax.swing.JTextField txtcasa;
    private javax.swing.JTextField txtcliente;
    // End of variables declaration//GEN-END:variables
}
